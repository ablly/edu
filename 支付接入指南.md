# 🚀 真实支付接入完整指南

## 📋 目录
1. [微信支付接入](#一微信支付接入)
2. [支付宝接入](#二支付宝接入)
3. [需要准备的信息清单](#三需要准备的信息清单)
4. [技术实现说明](#四技术实现说明)

---

## 一、微信支付接入

### 📝 1.1 资质要求

您需要具备以下资质之一：
- **企业**：营业执照、法人身份证、对公账户
- **个体工商户**：营业执照、经营者身份证、对公/对私账户
- **政府/事业单位**：相关证明文件

⚠️ **重要**：微信支付**不支持个人开发者**，必须有营业执照。

---

### 🔧 1.2 申请步骤

#### 步骤1：注册微信支付商户号

1. 访问：https://pay.weixin.qq.com/
2. 点击"接入微信支付"
3. 选择"注册微信支付商户号"
4. 填写主体信息：
   - 主体类型（企业/个体工商户等）
   - 营业执照信息
   - 法人/经营者信息
   - 联系人信息
5. 填写经营信息：
   - 商户简称
   - 经营类别（选择"教育培训"）
   - 经营场景（选择"公众号/小程序/APP/PC网站"）
   - 售卖商品/服务描述："在线教育会员服务"
6. 填写结算信息：
   - 结算账户类型（对公/对私）
   - 账户信息
7. 上传证件照片
8. 提交审核（通常1-5个工作日）

#### 步骤2：开通Native支付（扫码支付）

1. 登录微信支付商户平台：https://pay.weixin.qq.com/
2. 进入"产品中心"
3. 找到"Native支付"（扫码支付）
4. 点击"开通"
5. 配置支付授权目录（您的网站域名）

#### 步骤3：配置API密钥

1. 登录商户平台
2. 进入"账户中心" → "API安全"
3. 设置API密钥（APIv3密钥）
   - 点击"设置密钥"
   - **自己设置32位的随机字符串**（务必保存好）
   - 示例：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

#### 步骤4：下载API证书

1. 在"API安全"页面
2. 下载"API证书"
3. 会得到三个文件：
   - `apiclient_cert.pem` (证书文件)
   - `apiclient_key.pem` (私钥文件)
   - `apiclient_cert.p12` (证书文件)

---

### 📤 1.3 微信支付需要提供给我的信息

申请完成后，请提供以下信息：

```ini
# 微信支付配置信息
[WECHAT_PAY]
# 商户号（mch_id）- 在商户平台"账户中心"可以看到
MCHID = 1234567890

# 商户API证书序列号 - 在"API安全"页面可以看到
CERT_SERIAL_NO = 5BD9XXXXXXXXXXXXXXXXXXXXXXXXXX

# APIv3密钥 - 您自己设置的32位字符串
API_V3_KEY = a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

# 应用APPID - 如果有公众号/小程序，提供APPID；否则使用直连商户号
# 如果没有公众号，可以只用商户号也可以
APP_ID = wxXXXXXXXXXXXXXXXX

# API证书文件（请将三个文件发给我）
# apiclient_cert.pem
# apiclient_key.pem
```

**获取商户号和证书序列号**：
- 登录商户平台 → 账户中心 → 商户信息 → 可以看到"商户号"
- 账户中心 → API安全 → API证书 → 可以看到"证书序列号"

---

## 二、支付宝接入

### 📝 2.1 资质要求

- **企业**：营业执照、法人身份证、对公账户
- **个体工商户**：营业执照、经营者身份证
- **个人开发者**：支付宝支持个人开发者（但商户功能有限）

✅ **优势**：支付宝支持个人开发者

---

### 🔧 2.2 申请步骤

#### 步骤1：注册开放平台账号

1. 访问：https://open.alipay.com/
2. 使用支付宝账号登录
3. 进入"开发者中心"
4. 完成实名认证

#### 步骤2：创建应用

1. 进入"网页&移动应用"
2. 点击"创建应用"
3. 选择"网页应用"
4. 填写应用信息：
   - 应用名称："Edu-Pilot教育协控系统"
   - 应用图标：上传您的LOGO
   - 应用描述："在线教育会员管理系统"
5. 提交审核（通常1-3个工作日）

#### 步骤3：配置应用

审核通过后：
1. 进入应用详情页
2. 配置"接口加签方式"：
   - **重要**：选择"公钥"模式（不要选证书）
   - 点击"设置"
   
#### 步骤4：生成RSA密钥对

**方法A：使用支付宝提供的工具（推荐）**

1. 下载"支付宝密钥生成器"
   - Windows: https://ideservice.alipay.com/ide/getPluginUrl.htm?clientType=assistant&platform=win&clientVersion=0.0.1
   - Mac: https://ideservice.alipay.com/ide/getPluginUrl.htm?clientType=assistant&platform=mac&clientVersion=0.0.1
2. 打开工具，选择"2048位"
3. 点击"生成密钥"
4. 会得到：
   - 应用私钥（RSA2私钥）- **务必保存**
   - 应用公钥（RSA2公钥）- 复制到支付宝后台

**方法B：使用在线工具**

1. 访问：http://www.metools.info/code/c80.html
2. 选择"PKCS8(JAVA适用)-2048位"
3. 点击"生成密钥"
4. 保存：
   - PKCS8格式私钥 → 这个是您要保存的
   - 公钥 → 复制到支付宝后台

#### 步骤5：上传公钥到支付宝

1. 在应用详情页，找到"接口加签方式"
2. 点击"设置"
3. 选择"公钥"
4. 粘贴刚才生成的**应用公钥**
5. 点击"保存"
6. 保存后，支付宝会显示"支付宝公钥"
   - **复制这个支付宝公钥**，后面会用到

#### 步骤6：添加功能

1. 在应用详情页，找到"功能列表"
2. 添加以下功能：
   - **手机网站支付** (支持手机浏览器)
   - **电脑网站支付** (支持PC浏览器)
   - **当面付** (可选，支持扫码支付)
3. 每个功能都需要签约（免费）

#### 步骤7：配置授权回调地址

1. 在应用详情页
2. 找到"授权回调地址"
3. 填写：`https://您的域名/api/payment/alipay/callback`
4. 如果是测试，可以填：`http://您的IP:5000/api/payment/alipay/callback`

---

### 📤 2.3 支付宝需要提供给我的信息

申请完成后，请提供以下信息：

```ini
# 支付宝配置信息
[ALIPAY]
# 应用APPID - 在应用详情页可以看到
APP_ID = 2021XXXXXXXXXXXX

# 应用私钥 - 您生成的RSA2私钥（PKCS8格式）
# 格式类似：MIIEvQIBADANBgkqhkiG9w0BAQEFAASC...（很长的一串）
APP_PRIVATE_KEY = MIIEvQIBADANBgkqhkiG9w0BAQEFAASCB...

# 支付宝公钥 - 在支付宝应用页面，上传公钥后获得
# 格式类似：MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A...（很长的一串）
ALIPAY_PUBLIC_KEY = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A...

# 支付宝网关（正式环境）
ALIPAY_GATEWAY = https://openapi.alipay.com/gateway.do

# 支付宝网关（沙箱环境，用于测试）
# ALIPAY_GATEWAY = https://openapi.alipaydev.com/gateway.do
```

**获取各项信息的位置**：
- APP_ID：登录开放平台 → 我的应用 → 点击应用 → 应用信息
- APP_PRIVATE_KEY：您自己生成的私钥（千万不要给任何人）
- ALIPAY_PUBLIC_KEY：在设置公钥时，支付宝返回的公钥

---

## 三、需要准备的信息清单

### ✅ 立即需要准备的

#### 3.1 企业/商户基础信息
```
企业名称：___________________
统一社会信用代码：___________________
法人姓名：___________________
经营类目：教育培训/在线教育
```

#### 3.2 联系方式
```
联系人姓名：___________________
联系电话：___________________
联系邮箱：___________________
```

#### 3.3 网站信息
```
网站域名：___________________
备案号：___________________（如果有）
服务器IP：___________________
```

### 📝 申请后需要提供的

#### 3.4 微信支付配置
```ini
WECHAT_MCHID = ___________________
WECHAT_CERT_SERIAL_NO = ___________________
WECHAT_API_V3_KEY = ___________________
WECHAT_APP_ID = ___________________（可选）

# 三个证书文件：
# - apiclient_cert.pem
# - apiclient_key.pem
# - apiclient_cert.p12
```

#### 3.5 支付宝配置
```ini
ALIPAY_APP_ID = ___________________
ALIPAY_APP_PRIVATE_KEY = ___________________
ALIPAY_PUBLIC_KEY = ___________________
```

---

## 四、技术实现说明

### 🔧 4.1 我需要实现的功能模块

当您提供上述信息后，我将实现：

#### 后端模块
1. **`utils/payment_wechat.py`** - 微信支付封装
   - 创建Native支付订单（生成二维码）
   - 查询订单状态
   - 接收支付回调通知
   - 验证签名

2. **`utils/payment_alipay.py`** - 支付宝封装
   - 创建网页支付订单（跳转/扫码）
   - 查询订单状态
   - 接收支付回调通知
   - 验证签名

3. **`app.py` - 支付相关路由**
   - `/api/payment/create` - 创建支付订单
   - `/api/payment/query/<order_id>` - 查询订单状态
   - `/api/payment/wechat/callback` - 微信支付回调
   - `/api/payment/alipay/callback` - 支付宝回调
   - `/api/payment/cancel/<order_id>` - 取消订单

#### 前端模块
4. **`templates/payment.html`** - 支付页面
   - 会员套餐选择
   - 支付方式选择（微信/支付宝）
   - 二维码展示（微信）
   - 页面跳转（支付宝）
   - 支付状态轮询

5. **`static/js/payment.js`** - 支付逻辑
   - 创建订单
   - 展示支付二维码/跳转
   - 轮询订单状态（每2秒）
   - 支付成功后跳转

#### 数据库更新
6. **`PaymentTransaction` 模型扩展**
   - 添加支付渠道字段
   - 添加第三方交易号
   - 添加支付回调数据

---

### 🔒 4.2 安全保障措施

我将实现以下安全措施：

1. **签名验证**：所有回调必须验证签名
2. **订单防重复**：防止重复支付/回调
3. **金额校验**：回调金额必须与订单金额一致
4. **HTTPS强制**：生产环境强制使用HTTPS
5. **日志记录**：记录所有支付操作
6. **异常处理**：完善的错误处理和回滚机制

---

### 📦 4.3 需要安装的Python库

```bash
# 微信支付SDK
pip install wechatpayv3

# 支付宝SDK
pip install alipay-sdk-python

# 二维码生成
pip install qrcode pillow
```

---

## 五、申请流程时间表

| 步骤 | 预计时间 | 说明 |
|------|----------|------|
| 准备资质材料 | 1-2天 | 营业执照、身份证等 |
| 微信支付申请 | 1-5工作日 | 审核时间 |
| 支付宝申请 | 1-3工作日 | 审核时间 |
| 生成密钥配置 | 1小时 | 按照上述步骤操作 |
| 提供配置给我 | - | 填写上述信息清单 |
| 我实现代码 | 4-6小时 | 完整的支付功能 |
| 测试验证 | 1-2小时 | 沙箱环境测试 |
| 上线 | - | 切换到正式环境 |

**总计**：约3-7个工作日完成申请，1天完成开发和测试。

---

## 六、常见问题

### Q1: 没有营业执照可以用微信支付吗？
**A**: 不可以。微信支付必须有营业执照。如果暂时没有，可以：
- 先只接入支付宝（支持个人）
- 或使用第三方聚合支付（如Ping++、BeeCloud）

### Q2: 个人开发者可以用支付宝吗？
**A**: 可以。支付宝支持个人开发者，但功能会有限制。

### Q3: 沙箱环境如何测试？
**A**: 
- 微信支付：商户平台有沙箱环境
- 支付宝：https://openhome.alipay.com/platform/appDaily.htm?tab=account

### Q4: 回调地址必须是HTTPS吗？
**A**: 
- 生产环境：是的，必须HTTPS
- 测试环境：可以用HTTP，但需要配置白名单

### Q5: 费率是多少？
**A**: 
- 微信支付：0.6%（行业不同费率不同）
- 支付宝：0.6%（行业不同费率不同）
- 可以申请费率优惠

---

## 七、下一步行动

### 🎯 您现在需要做的：

1. **决定使用哪种支付方式**
   - [ ] 微信支付（需要营业执照）
   - [ ] 支付宝（可以个人申请）
   - [ ] 两者都要（推荐）

2. **准备资质材料**
   - [ ] 营业执照扫描件
   - [ ] 法人身份证
   - [ ] 对公账户信息（或对私）

3. **开始申请**
   - [ ] 按照上述步骤1.2申请微信支付
   - [ ] 按照上述步骤2.2申请支付宝

4. **获取配置信息**
   - [ ] 填写"三、需要准备的信息清单"
   - [ ] 将密钥、证书、APPID等提供给我

5. **测试环境准备**
   - [ ] 确认服务器域名/IP
   - [ ] 确认是否有HTTPS证书

---

## 📞 联系我

当您完成申请并获得以下信息后，请告诉我：

```
✅ 微信支付配置：
   MCHID = ______
   CERT_SERIAL_NO = ______
   API_V3_KEY = ______
   APP_ID = ______ (可选)
   证书文件已准备

✅ 支付宝配置：
   APP_ID = ______
   APP_PRIVATE_KEY = ______
   ALIPAY_PUBLIC_KEY = ______

✅ 其他信息：
   网站域名 = ______
   是否有HTTPS = 是/否
```

然后我将立即为您实现**真实的商用支付系统**！

---

**最后提醒**：
- 所有私钥、密钥务必妥善保管，不要泄露
- 证书文件不要上传到公开的代码仓库
- 建议使用环境变量或配置文件管理敏感信息
- 测试时先用沙箱环境，确认无误后再上线


